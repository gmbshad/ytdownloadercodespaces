<html>
<head>
<title>DashboardViewModel.cs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #c679dd; font-style: italic;}
.s1 { color: #abb2bf;}
.s2 { color: #d19a66;}
.s3 { color: #59626f; font-style: italic;}
.s4 { color: #98c379;}
</style>
</head>
<body bgcolor="#282c34">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DashboardViewModel.cs</font>
</center></td></tr></table>
<pre><span class="s0">using </span><span class="s1">System;</span>
<span class="s0">using </span><span class="s1">System.IO;</span>
<span class="s0">using </span><span class="s1">System.Linq;</span>
<span class="s0">using </span><span class="s1">System.Threading.Tasks;</span>
<span class="s0">using </span><span class="s1">Gress;</span>
<span class="s0">using </span><span class="s1">Gress.Completable;</span>
<span class="s0">using </span><span class="s1">Stylet;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Core.Downloading;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Core.Resolving;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Core.Tagging;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Services;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Utils;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.ViewModels.Dialogs;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.ViewModels.Framework;</span>
<span class="s0">using </span><span class="s1">YoutubeExplode.Exceptions;</span>

<span class="s0">namespace </span><span class="s1">YoutubeDownloader.ViewModels.Components;</span>

<span class="s0">public class </span><span class="s1">DashboardViewModel : PropertyChangedBase, IDisposable</span>
<span class="s1">{</span>
    <span class="s0">private readonly </span><span class="s1">IViewModelFactory _viewModelFactory;</span>
    <span class="s0">private readonly </span><span class="s1">DialogManager _dialogManager;</span>
    <span class="s0">private readonly </span><span class="s1">SettingsService _settingsService;</span>

    <span class="s0">private readonly </span><span class="s1">AutoResetProgressMuxer _progressMuxer;</span>
    <span class="s0">private readonly </span><span class="s1">ResizableSemaphore _downloadSemaphore = </span><span class="s0">new</span><span class="s1">();</span>

    <span class="s0">private readonly </span><span class="s1">QueryResolver _queryResolver = </span><span class="s0">new</span><span class="s1">();</span>
    <span class="s0">private readonly </span><span class="s1">VideoDownloader _videoDownloader = </span><span class="s0">new</span><span class="s1">();</span>
    <span class="s0">private readonly </span><span class="s1">MediaTagInjector _mediaTagInjector = </span><span class="s0">new</span><span class="s1">();</span>

    <span class="s0">public bool </span><span class="s1">IsBusy { get; </span><span class="s0">private </span><span class="s1">set; }</span>

    <span class="s0">public </span><span class="s1">ProgressContainer&lt;Percentage&gt; Progress { get; } = </span><span class="s0">new</span><span class="s1">();</span>

    <span class="s0">public bool </span><span class="s1">IsProgressIndeterminate =&gt; IsBusy &amp;&amp; Progress.Current.Fraction </span><span class="s0">is </span><span class="s1">&lt;= </span><span class="s2">0 </span><span class="s1">or &gt;= </span><span class="s2">1</span><span class="s1">;</span>

    <span class="s0">public string</span><span class="s1">? Query { get; set; }</span>

    <span class="s0">public </span><span class="s1">BindableCollection&lt;DownloadViewModel&gt; Downloads { get; } = </span><span class="s0">new</span><span class="s1">();</span>

    <span class="s0">public </span><span class="s1">DashboardViewModel(</span>
        <span class="s1">IViewModelFactory viewModelFactory,</span>
        <span class="s1">DialogManager dialogManager,</span>
        <span class="s1">SettingsService settingsService)</span>
    <span class="s1">{</span>
        <span class="s1">_viewModelFactory = viewModelFactory;</span>
        <span class="s1">_dialogManager = dialogManager;</span>
        <span class="s1">_settingsService = settingsService;</span>

        <span class="s1">_progressMuxer = Progress.CreateMuxer().WithAutoReset();</span>

        <span class="s1">_settingsService.BindAndInvoke(o =&gt; o.ParallelLimit, (_, e) =&gt; _downloadSemaphore.MaxCount = e.NewValue);</span>
        <span class="s1">Progress.Bind(o =&gt; o.Current, (_, _) =&gt; NotifyOfPropertyChange(() =&gt; IsProgressIndeterminate));</span>
    <span class="s1">}</span>

    <span class="s0">public bool </span><span class="s1">CanShowSettings =&gt; !IsBusy;</span>

    <span class="s0">public </span><span class="s1">async </span><span class="s0">void </span><span class="s1">ShowSettings() =&gt; await _dialogManager.ShowDialogAsync(</span>
        <span class="s1">_viewModelFactory.CreateSettingsViewModel()</span>
    <span class="s1">);</span>

    <span class="s0">private void </span><span class="s1">EnqueueDownload(DownloadViewModel download, </span><span class="s0">int </span><span class="s1">position = </span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s1">var progress = _progressMuxer.CreateInput();</span>

        <span class="s1">Task.Run(async () =&gt;</span>
        <span class="s1">{</span>
            <span class="s0">try</span>
            <span class="s1">{</span>
                <span class="s0">using </span><span class="s1">var access = await _downloadSemaphore.AcquireAsync(download.CancellationToken);</span>

                <span class="s1">download.Status = DownloadStatus.Started;</span>

                <span class="s1">var downloadOption =</span>
                    <span class="s1">download.DownloadOption ??</span>
                    <span class="s1">await _videoDownloader.GetBestDownloadOptionAsync(</span>
                        <span class="s1">download.Video!.Id,</span>
                        <span class="s1">download.DownloadPreference!,</span>
                        <span class="s1">download.CancellationToken</span>
                    <span class="s1">);</span>

                <span class="s1">await _videoDownloader.DownloadVideoAsync(</span>
                    <span class="s1">download.FilePath!,</span>
                    <span class="s1">download.Video!,</span>
                    <span class="s1">downloadOption,</span>
                    <span class="s1">download.Progress.Merge(progress),</span>
                    <span class="s1">download.CancellationToken</span>
                <span class="s1">);</span>

                <span class="s0">if </span><span class="s1">(_settingsService.ShouldInjectTags)</span>
                <span class="s1">{</span>
                    <span class="s0">try</span>
                    <span class="s1">{</span>
                        <span class="s1">await _mediaTagInjector.InjectTagsAsync(</span>
                            <span class="s1">download.FilePath!,</span>
                            <span class="s1">download.Video!,</span>
                            <span class="s1">download.CancellationToken</span>
                        <span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s0">catch</span>
                    <span class="s1">{</span>
                        <span class="s3">// Media tagging is not critical</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>

                <span class="s1">download.Status = DownloadStatus.Completed;</span>
            <span class="s1">}</span>
            <span class="s0">catch </span><span class="s1">(Exception ex)</span>
            <span class="s1">{</span>
                <span class="s0">try</span>
                <span class="s1">{</span>
                    <span class="s3">// Delete incompletely downloaded file</span>
                    <span class="s1">File.Delete(download.FilePath!);</span>
                <span class="s1">}</span>
                <span class="s0">catch</span>
                <span class="s1">{</span>
                    <span class="s3">// Ignore</span>
                <span class="s1">}</span>

                <span class="s1">download.Status = ex </span><span class="s0">is </span><span class="s1">OperationCanceledException</span>
                    <span class="s1">? DownloadStatus.Canceled</span>
                    <span class="s1">: DownloadStatus.Failed;</span>

                <span class="s3">// Short error message for YouTube-related errors, full for others</span>
                <span class="s1">download.ErrorMessage = ex </span><span class="s0">is </span><span class="s1">YoutubeExplodeException</span>
                    <span class="s1">? ex.Message</span>
                    <span class="s1">: ex.ToString();</span>
            <span class="s1">}</span>
            <span class="s0">finally</span>
            <span class="s1">{</span>
                <span class="s1">progress.ReportCompletion();</span>
                <span class="s1">download.Dispose();</span>
            <span class="s1">}</span>
        <span class="s1">});</span>

        <span class="s1">Downloads.Insert(position, download);</span>
    <span class="s1">}</span>

    <span class="s0">public bool </span><span class="s1">CanProcessQuery =&gt; !IsBusy &amp;&amp; !</span><span class="s0">string</span><span class="s1">.IsNullOrWhiteSpace(Query);</span>

    <span class="s0">public </span><span class="s1">async </span><span class="s0">void </span><span class="s1">ProcessQuery()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">string</span><span class="s1">.IsNullOrWhiteSpace(Query))</span>
            <span class="s0">return</span><span class="s1">;</span>

        <span class="s1">IsBusy = </span><span class="s0">true</span><span class="s1">;</span>

        <span class="s3">// Small weight to not offset any existing download operations</span>
        <span class="s1">var progress = _progressMuxer.CreateInput(</span><span class="s2">0.01</span><span class="s1">);</span>

        <span class="s0">try</span>
        <span class="s1">{</span>
            <span class="s1">var result = await _queryResolver.ResolveAsync(</span>
                <span class="s1">Query.Split(</span><span class="s4">&quot;\n&quot;</span><span class="s1">, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries),</span>
                <span class="s1">progress</span>
            <span class="s1">);</span>

            <span class="s3">// Single video</span>
            <span class="s0">if </span><span class="s1">(result.Videos.Count == </span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">{</span>
                <span class="s1">var video = result.Videos.Single();</span>
                <span class="s1">var downloadOptions = await _videoDownloader.GetDownloadOptionsAsync(video.Id);</span>

                <span class="s1">var download = await _dialogManager.ShowDialogAsync(</span>
                    <span class="s1">_viewModelFactory.CreateDownloadSingleSetupViewModel(video, downloadOptions)</span>
                <span class="s1">);</span>

                <span class="s0">if </span><span class="s1">(download </span><span class="s0">is null</span><span class="s1">)</span>
                    <span class="s0">return</span><span class="s1">;</span>

                <span class="s1">EnqueueDownload(download);</span>
            <span class="s1">}</span>
            <span class="s3">// Multiple videos</span>
            <span class="s0">else if </span><span class="s1">(result.Videos.Count &gt; </span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">{</span>
                <span class="s1">var downloads = await _dialogManager.ShowDialogAsync(</span>
                    <span class="s1">_viewModelFactory.CreateDownloadMultipleSetupViewModel(</span>
                        <span class="s1">result.Title,</span>
                        <span class="s1">result.Videos,</span>
                        <span class="s3">// Pre-select videos if they come from a single query and not from search</span>
                        <span class="s1">result.Kind </span><span class="s0">is </span><span class="s1">not QueryResultKind.Search and not QueryResultKind.Aggregate</span>
                    <span class="s1">)</span>
                <span class="s1">);</span>

                <span class="s0">if </span><span class="s1">(downloads </span><span class="s0">is null</span><span class="s1">)</span>
                    <span class="s0">return</span><span class="s1">;</span>

                <span class="s0">foreach </span><span class="s1">(var download </span><span class="s0">in </span><span class="s1">downloads)</span>
                    <span class="s1">EnqueueDownload(download);</span>
            <span class="s1">}</span>
            <span class="s3">// No videos found</span>
            <span class="s0">else</span>
            <span class="s1">{</span>
                <span class="s1">await _dialogManager.ShowDialogAsync(</span>
                    <span class="s1">_viewModelFactory.CreateMessageBoxViewModel(</span>
                        <span class="s4">&quot;Nothing found&quot;</span><span class="s1">,</span>
                        <span class="s4">&quot;Couldn't find any videos based on the query or URL you provided&quot;</span>
                    <span class="s1">)</span>
                <span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">catch </span><span class="s1">(Exception ex)</span>
        <span class="s1">{</span>
            <span class="s1">await _dialogManager.ShowDialogAsync(</span>
                <span class="s1">_viewModelFactory.CreateMessageBoxViewModel(</span>
                    <span class="s4">&quot;Error&quot;</span><span class="s1">,</span>
                    <span class="s3">// Short error message for YouTube-related errors, full for others</span>
                    <span class="s1">ex </span><span class="s0">is </span><span class="s1">YoutubeExplodeException</span>
                        <span class="s1">? ex.Message</span>
                        <span class="s1">: ex.ToString()</span>
                <span class="s1">)</span>
            <span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s0">finally</span>
        <span class="s1">{</span>
            <span class="s1">progress.ReportCompletion();</span>
            <span class="s1">IsBusy = </span><span class="s0">false</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">RemoveDownload(DownloadViewModel download)</span>
    <span class="s1">{</span>
        <span class="s1">Downloads.Remove(download);</span>
        <span class="s1">download.Cancel();</span>
        <span class="s1">download.Dispose();</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">RemoveSuccessfulDownloads()</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(var download </span><span class="s0">in </span><span class="s1">Downloads.ToArray())</span>
        <span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(download.Status == DownloadStatus.Completed)</span>
                <span class="s1">RemoveDownload(download);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">RemoveInactiveDownloads()</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(var download </span><span class="s0">in </span><span class="s1">Downloads.ToArray())</span>
        <span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(download.Status </span><span class="s0">is </span><span class="s1">DownloadStatus.Completed or DownloadStatus.Failed or DownloadStatus.Canceled)</span>
                <span class="s1">RemoveDownload(download);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">RestartDownload(DownloadViewModel download)</span>
    <span class="s1">{</span>
        <span class="s1">var position = Math.Max(</span><span class="s2">0</span><span class="s1">, Downloads.IndexOf(download));</span>
        <span class="s1">RemoveDownload(download);</span>

        <span class="s1">var newDownload = download.DownloadOption </span><span class="s0">is </span><span class="s1">not </span><span class="s0">null</span>
            <span class="s1">? _viewModelFactory.CreateDownloadViewModel(</span>
                <span class="s1">download.Video!,</span>
                <span class="s1">download.DownloadOption,</span>
                <span class="s1">download.FilePath!</span>
            <span class="s1">)</span>
            <span class="s1">: _viewModelFactory.CreateDownloadViewModel(</span>
                <span class="s1">download.Video!,</span>
                <span class="s1">download.DownloadPreference!,</span>
                <span class="s1">download.FilePath!</span>
            <span class="s1">);</span>

        <span class="s1">EnqueueDownload(newDownload, position);</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">RestartFailedDownloads()</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(var download </span><span class="s0">in </span><span class="s1">Downloads.ToArray())</span>
        <span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(download.Status == DownloadStatus.Failed)</span>
                <span class="s1">RestartDownload(download);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">CancelAllDownloads()</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(var download </span><span class="s0">in </span><span class="s1">Downloads)</span>
            <span class="s1">download.Cancel();</span>
    <span class="s1">}</span>

    <span class="s0">public void </span><span class="s1">Dispose()</span>
    <span class="s1">{</span>
        <span class="s1">_downloadSemaphore.Dispose();</span>
    <span class="s1">}</span>
<span class="s1">}</span></pre>
</body>
</html>