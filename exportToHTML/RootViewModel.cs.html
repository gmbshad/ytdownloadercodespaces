<html>
<head>
<title>RootViewModel.cs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #c679dd; font-style: italic;}
.s1 { color: #abb2bf;}
.s2 { color: #d19a66;}
.s3 { color: #98c379;}
.s4 { color: #59626f; font-style: italic;}
</style>
</head>
<body bgcolor="#282c34">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RootViewModel.cs</font>
</center></td></tr></table>
<pre><span class="s0">using </span><span class="s1">System;</span>
<span class="s0">using </span><span class="s1">System.Threading.Tasks;</span>
<span class="s0">using </span><span class="s1">MaterialDesignThemes.Wpf;</span>
<span class="s0">using </span><span class="s1">Stylet;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Services;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.Utils;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.ViewModels.Components;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.ViewModels.Dialogs;</span>
<span class="s0">using </span><span class="s1">YoutubeDownloader.ViewModels.Framework;</span>

<span class="s0">namespace </span><span class="s1">YoutubeDownloader.ViewModels;</span>

<span class="s0">public class </span><span class="s1">RootViewModel : Screen</span>
<span class="s1">{</span>
    <span class="s0">private readonly </span><span class="s1">IViewModelFactory _viewModelFactory;</span>
    <span class="s0">private readonly </span><span class="s1">DialogManager _dialogManager;</span>
    <span class="s0">private readonly </span><span class="s1">SettingsService _settingsService;</span>
    <span class="s0">private readonly </span><span class="s1">UpdateService _updateService;</span>

    <span class="s0">public </span><span class="s1">SnackbarMessageQueue Notifications { get; } = </span><span class="s0">new</span><span class="s1">(TimeSpan.FromSeconds(</span><span class="s2">5</span><span class="s1">));</span>

    <span class="s0">public </span><span class="s1">DashboardViewModel Dashboard { get; }</span>

    <span class="s0">public </span><span class="s1">RootViewModel(</span>
        <span class="s1">IViewModelFactory viewModelFactory,</span>
        <span class="s1">DialogManager dialogManager,</span>
        <span class="s1">SettingsService settingsService,</span>
        <span class="s1">UpdateService updateService)</span>
    <span class="s1">{</span>
        <span class="s1">_viewModelFactory = viewModelFactory;</span>
        <span class="s1">_dialogManager = dialogManager;</span>
        <span class="s1">_settingsService = settingsService;</span>
        <span class="s1">_updateService = updateService;</span>

        <span class="s1">Dashboard = _viewModelFactory.CreateDashboardViewModel();</span>

        <span class="s1">DisplayName = $</span><span class="s3">&quot;{App.Name} v{App.VersionString}&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">private </span><span class="s1">async Task ShowWarInUkraineMessageAsync()</span>
    <span class="s1">{</span>
        <span class="s1">var dialog = _viewModelFactory.CreateMessageBoxViewModel(</span>
            <span class="s3">&quot;Ukraine is at war!&quot;</span><span class="s1">, @</span><span class="s3">&quot;</span>
<span class="s1">My country, Ukraine, has been invaded by Russian military forces </span><span class="s0">in </span><span class="s1">an act of aggression that can only be described </span><span class="s0">as </span><span class="s1">genocide.</span>
<span class="s1">Be on the right side of history! Consider supporting Ukraine </span><span class="s0">in </span><span class="s1">its fight </span><span class="s0">for </span><span class="s1">freedom.</span>

<span class="s1">Press LEARN MORE to find ways that you can help.</span><span class="s3">&quot;.Trim(),</span>
            <span class="s3">&quot;LEARN MORE&quot;</span><span class="s1">, </span><span class="s3">&quot;CLOSE&quot;</span>
        <span class="s1">);</span>

        <span class="s0">if </span><span class="s1">(await _dialogManager.ShowDialogAsync(dialog) == </span><span class="s0">true</span><span class="s1">)</span>
        <span class="s1">{</span>
            <span class="s1">ProcessEx.StartShellExecute(</span><span class="s3">&quot;https://tyrrrz.me/ukraine?source=youtubedownloader&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private </span><span class="s1">async Task CheckForUpdatesAsync()</span>
    <span class="s1">{</span>
        <span class="s0">try</span>
        <span class="s1">{</span>
            <span class="s1">var updateVersion = await _updateService.CheckForUpdatesAsync();</span>
            <span class="s0">if </span><span class="s1">(updateVersion </span><span class="s0">is null</span><span class="s1">)</span>
                <span class="s0">return</span><span class="s1">;</span>

            <span class="s1">Notifications.Enqueue($</span><span class="s3">&quot;Downloading update to {App.Name} v{updateVersion}...&quot;</span><span class="s1">);</span>
            <span class="s1">await _updateService.PrepareUpdateAsync(updateVersion);</span>

            <span class="s1">Notifications.Enqueue(</span>
                <span class="s3">&quot;Update has been downloaded and will be installed when you exit&quot;</span><span class="s1">,</span>
                <span class="s3">&quot;INSTALL NOW&quot;</span><span class="s1">, () =&gt;</span>
                <span class="s1">{</span>
                    <span class="s1">_updateService.FinalizeUpdate(</span><span class="s0">true</span><span class="s1">);</span>
                    <span class="s1">RequestClose();</span>
                <span class="s1">}</span>
            <span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s0">catch</span>
        <span class="s1">{</span>
            <span class="s4">// Failure to update shouldn't crash the application</span>
            <span class="s1">Notifications.Enqueue(</span><span class="s3">&quot;Failed to perform application update&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">public </span><span class="s1">async </span><span class="s0">void </span><span class="s1">OnViewFullyLoaded()</span>
    <span class="s1">{</span>
        <span class="s1">await ShowWarInUkraineMessageAsync();</span>
        <span class="s1">await CheckForUpdatesAsync();</span>
    <span class="s1">}</span>

    <span class="s0">protected override void </span><span class="s1">OnViewLoaded()</span>
    <span class="s1">{</span>
        <span class="s0">base</span><span class="s1">.OnViewLoaded();</span>

        <span class="s1">_settingsService.Load();</span>

        <span class="s0">if </span><span class="s1">(_settingsService.IsDarkModeEnabled)</span>
        <span class="s1">{</span>
            <span class="s1">App.SetDarkTheme();</span>
        <span class="s1">}</span>
        <span class="s0">else</span>
        <span class="s1">{</span>
            <span class="s1">App.SetLightTheme();</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">protected override void </span><span class="s1">OnClose()</span>
    <span class="s1">{</span>
        <span class="s0">base</span><span class="s1">.OnClose();</span>

        <span class="s1">Dashboard.CancelAllDownloads();</span>

        <span class="s1">_settingsService.Save();</span>
        <span class="s1">_updateService.FinalizeUpdate(</span><span class="s0">false</span><span class="s1">);</span>
    <span class="s1">}</span>
<span class="s1">}</span></pre>
</body>
</html>